"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
Object.defineProperty(exports, "__esModule", { value: true });
var xstream_1 = require("xstream");
var adapt_1 = require("@cycle/run/lib/adapt");
var RouterSource_1 = require("./RouterSource");
var history_1 = require("history");
/**
 * Wraps main to provide an advanced interface over @cycle/history
 * @public
 * @method routerify
 * @return {main} The augmented main function
 */
function routerify(main, routeMatcher, options) {
    if (typeof main !== 'function') {
        throw new Error('First argument to routerify must be a valid cycle app');
    }
    var opts = __assign({ basename: '/', historyName: 'history', routerName: 'router', omitHistory: true }, options);
    var createHref = function (location) {
        return opts.basename + history_1.createPath(location);
    };
    return function (sources) {
        var _a, _b;
        var routerSource = new RouterSource_1.RouterSource(xstream_1.default.fromObservable(sources[opts.historyName]).remember(), [], createHref, routeMatcher, opts.routerName);
        var srcs = sources;
        if (opts.omitHistory) {
            delete srcs[opts.historyName];
        }
        var sinks = main(__assign({}, srcs, (_a = {}, _a[opts.routerName] = routerSource, _a)));
        return __assign({}, sinks, (_b = {}, _b[opts.historyName] = adapt_1.adapt(xstream_1.default.merge(sinks[opts.historyName] && !opts.omitHistory
            ? xstream_1.default.fromObservable(sinks[opts.historyName])
            : xstream_1.default.never(), sinks[opts.routerName]
            ? xstream_1.default.fromObservable(sinks[opts.routerName])
            : xstream_1.default.never())), _b));
    };
}
exports.routerify = routerify;
//# sourceMappingURL=routerify.js.map